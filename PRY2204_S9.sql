-- ===============================================
-- PRY2204 - EVALUACIÓN FINAL TRANSVERSAL (EFT)
-- SCRIPT DE IMPLEMENTACIÓN SQL (ORACLE / SQL DEVELOPER)
-- FECHA: 2025-10-11
-- ===============================================

-- 1. CONFIGURACIÓN INICIAL (Eliminación de Tablas)
-- Se recomienda ejecutar DROP TABLEs en orden inverso para evitar errores de FK.

DROP TABLE ASIGNACION_TURNO CASCADE CONSTRAINTS;
DROP TABLE ORDEN_MANTENCION CASCADE CONSTRAINTS;
DROP TABLE MAQUINA CASCADE CONSTRAINTS;
DROP TABLE TECNICO_MANTENCION CASCADE CONSTRAINTS;
DROP TABLE JEFE_TURNO CASCADE CONSTRAINTS;
DROP TABLE OPERARIO CASCADE CONSTRAINTS;
DROP TABLE EMPLEADO CASCADE CONSTRAINTS;
DROP TABLE PLANTA CASCADE CONSTRAINTS;
DROP TABLE TURNO CASCADE CONSTRAINTS;
DROP TABLE TIPO_MAQUINA CASCADE CONSTRAINTS;
DROP TABLE AFP CASCADE CONSTRAINTS;
DROP TABLE SISTEMA_SALUD CASCADE CONSTRAINTS;


-- 2. CREACIÓN DE TABLAS MAESTRAS (Sin dependencias)

-- AFP (Administradoras de Fondos de Pensiones)
CREATE TABLE AFP (
    ID_AFP        NUMBER(3)       PRIMARY KEY,
    NOMBRE_AFP    VARCHAR2(50)    NOT NULL UNIQUE
);

-- SISTEMA_SALUD (ISAPRE / FONASA)
CREATE TABLE SISTEMA_SALUD (
    ID_SISTEMA    NUMBER(3)       PRIMARY KEY,
    NOMBRE_SISTEMA VARCHAR2(50)   NOT NULL UNIQUE
);

-- PLANTA (Clave de la Clave Compuesta de MAQUINA)
CREATE TABLE PLANTA (
    ID_PLANTA     NUMBER(3)       PRIMARY KEY,
    NOMBRE_PLANTA VARCHAR2(100)   NOT NULL UNIQUE,
    UBICACION     VARCHAR2(100)   NOT NULL
);

-- TIPO_MAQUINA (Maestro para MAQUINA)
CREATE TABLE TIPO_MAQUINA (
    ID_TIPO       NUMBER(3)       PRIMARY KEY,
    NOMBRE_TIPO   VARCHAR2(50)    NOT NULL UNIQUE,
    DESCRIPCION   VARCHAR2(200)
);

-- TURNO (Usado en ASIGNACION_TURNO - PK Compuesta)
CREATE TABLE TURNO (
    ID_TURNO      NUMBER(3)       PRIMARY KEY,
    NOMBRE_TURNO  VARCHAR2(50)    NOT NULL UNIQUE,
    HORA_INICIO   VARCHAR2(5),
    HORA_FIN      VARCHAR2(5)
);


-- 3. CREACIÓN DE TABLA EMPLEADO (Padre de Generalización)

CREATE TABLE EMPLEADO (
    ID_EMPLEADO      NUMBER(6)       PRIMARY KEY,
    ID_SUBTIPO       NUMBER(6)       NOT NULL UNIQUE, -- Clave UNICA para la Generalización (Clave Alternativa)
    RUT              VARCHAR2(12)    NOT NULL UNIQUE,
    NOMBRES          VARCHAR2(100)   NOT NULL,
    APELLIDOS        VARCHAR2(100)   NOT NULL,
    FECHA_CONTRATO   DATE            NOT NULL,
    SALARIO          NUMBER(10)      NOT NULL,
    
    -- Foreign Keys a tablas maestras
    ID_PLANTA        NUMBER(3)       NOT NULL,
    ID_AFP           NUMBER(3)       NOT NULL,
    ID_SISTEMA       NUMBER(3)       NOT NULL,
    
    -- Foreign Key a sí mismo (Jefe Directo)
    ID_JEFE_DIRECTO  NUMBER(6),

    CONSTRAINT FK_EMP_PLANTA FOREIGN KEY (ID_PLANTA) REFERENCES PLANTA (ID_PLANTA),
    CONSTRAINT FK_EMP_AFP FOREIGN KEY (ID_AFP) REFERENCES AFP (ID_AFP),
    CONSTRAINT FK_EMP_SALUD FOREIGN KEY (ID_SISTEMA) REFERENCES SISTEMA_SALUD (ID_SISTEMA),
    CONSTRAINT FK_EMP_JEFE FOREIGN KEY (ID_JEFE_DIRECTO) REFERENCES EMPLEADO (ID_EMPLEADO)
);


-- 4. CREACIÓN DE TABLAS DE SUBTIPO (Generalización)
-- Implementación mediante Clave Alternativa: ID_SUBTIPO es PK y FK

-- OPERARIO
CREATE TABLE OPERARIO (
    ID_SUBTIPO             NUMBER(6)       PRIMARY KEY, -- Es PK y FK
    CATEGORIA_PROCESO      VARCHAR2(50)    NOT NULL,
    CERTIFICACION          VARCHAR2(100),
    HORAS_ESTANDAR_TURNO   NUMBER(2)       NOT NULL,
    
    CONSTRAINT FK_OP_EMP FOREIGN KEY (ID_SUBTIPO) REFERENCES EMPLEADO (ID_SUBTIPO) -- FK que apunta a la clave UNIQUE del padre
);

-- JEFE_TURNO
CREATE TABLE JEFE_TURNO (
    ID_SUBTIPO             NUMBER(6)       PRIMARY KEY, -- Es PK y FK
    AREA_RESPONSABILIDAD   VARCHAR2(100)   NOT NULL,
    MAX_OPERARIOS          NUMBER(3)       NOT NULL,
    
    CONSTRAINT FK_JT_EMP FOREIGN KEY (ID_SUBTIPO) REFERENCES EMPLEADO (ID_SUBTIPO)
);

-- TECNICO_MANTENCION
CREATE TABLE TECNICO_MANTENCION (
    ID_SUBTIPO             NUMBER(6)       PRIMARY KEY, -- Es PK y FK
    ESPECIALIDAD           VARCHAR2(100)   NOT NULL,
    NIVEL_CERTIFICACION    VARCHAR2(50)    NOT NULL,
    TIEMPO_RESPUESTA_ESTANDAR NUMBER(3),   -- En minutos
    
    CONSTRAINT FK_TM_EMP FOREIGN KEY (ID_SUBTIPO) REFERENCES EMPLEADO (ID_SUBTIPO)
);


-- 5. CREACIÓN DE TABLAS CON CLAVES COMPUESTAS

-- MAQUINA (Clave Compuesta: ID_PLANTA, ID_MAQUINA)
CREATE TABLE MAQUINA (
    ID_PLANTA       NUMBER(3)       NOT NULL,
    ID_MAQUINA      NUMBER(6)       NOT NULL,
    NOMBRE          VARCHAR2(100)   NOT NULL,
    ESTADO_ACTIVO   CHAR(1)         DEFAULT 'S' NOT NULL CHECK (ESTADO_ACTIVO IN ('S', 'N')),
    FECHA_INSTALACION DATE          NOT NULL,
    
    ID_TIPO_MAQUINA NUMBER(3)       NOT NULL,

    CONSTRAINT PK_MAQUINA PRIMARY KEY (ID_PLANTA, ID_MAQUINA), -- PK Compuesta
    CONSTRAINT FK_MAQ_PLANTA FOREIGN KEY (ID_PLANTA) REFERENCES PLANTA (ID_PLANTA),
    CONSTRAINT FK_MAQ_TIPO FOREIGN KEY (ID_TIPO_MAQUINA) REFERENCES TIPO_MAQUINA (ID_TIPO)
);

-- ORDEN_MANTENCION (Referencia FK Compuesta a MAQUINA)
CREATE TABLE ORDEN_MANTENCION (
    ID_ORDEN             NUMBER(8)       PRIMARY KEY,
    FECHA_PROGRAMADA     DATE            NOT NULL,
    DESCRIPCION_TRABAJO  VARCHAR2(500)   NOT NULL,
    ESTADO_ORDEN         VARCHAR2(20)    DEFAULT 'PENDIENTE' NOT NULL,
    
    -- FK Compuesta que referencia a MAQUINA
    ID_PLANTA            NUMBER(3)       NOT NULL,
    ID_MAQUINA           NUMBER(6)       NOT NULL,

    CONSTRAINT FK_OM_MAQUINA FOREIGN KEY (ID_PLANTA, ID_MAQUINA) REFERENCES MAQUINA (ID_PLANTA, ID_MAQUINA)
);

-- ASIGNACION_TURNO (PK Compuesta: FECHA, ID_EMPLEADO, ID_TURNO, ID_PLANTA, ID_MAQUINA)
CREATE TABLE ASIGNACION_TURNO (
    FECHA           DATE            NOT NULL,
    ID_EMPLEADO     NUMBER(6)       NOT NULL,
    ID_TURNO        NUMBER(3)       NOT NULL,
    
    -- FK Compuesta que referencia a MAQUINA
    ID_PLANTA       NUMBER(3)       NOT NULL,
    ID_MAQUINA      NUMBER(6)       NOT NULL,
    
    ROL_DESEMPEÑADO VARCHAR2(50)    DEFAULT 'ASIGNADO' NOT NULL,
    
    CONSTRAINT PK_ASIGNACION PRIMARY KEY (FECHA, ID_EMPLEADO, ID_TURNO, ID_PLANTA, ID_MAQUINA), -- PK Compuesta de 5 atributos
    
    CONSTRAINT FK_ASIG_EMP FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO (ID_EMPLEADO),
    CONSTRAINT FK_ASIG_TURNO FOREIGN KEY (ID_TURNO) REFERENCES TURNO (ID_TURNO),
    CONSTRAINT FK_ASIG_MAQUINA FOREIGN KEY (ID_PLANTA, ID_MAQUINA) REFERENCES MAQUINA (ID_PLANTA, ID_MAQUINA)
);


-- 6. INSERCIÓN DE DATOS DE PRUEBA (POBLAMIENTO)

-- Maestras
INSERT INTO AFP (ID_AFP, NOMBRE_AFP) VALUES (101, 'Habitat');
INSERT INTO AFP (ID_AFP, NOMBRE_AFP) VALUES (102, 'Provida');

INSERT INTO SISTEMA_SALUD (ID_SISTEMA, NOMBRE_SISTEMA) VALUES (201, 'Fonasa');
INSERT INTO SISTEMA_SALUD (ID_SISTEMA, NOMBRE_SISTEMA) VALUES (202, 'Colmena');

INSERT INTO PLANTA (ID_PLANTA, NOMBRE_PLANTA, UBICACION) VALUES (301, 'Planta Norte', 'Antofagasta');
INSERT INTO PLANTA (ID_PLANTA, NOMBRE_PLANTA, UBICACION) VALUES (302, 'Planta Sur', 'Puerto Montt');

INSERT INTO TIPO_MAQUINA (ID_TIPO, NOMBRE_TIPO, DESCRIPCION) VALUES (401, 'Cinta Transportadora', 'Equipo de movimiento de materiales');
INSERT INTO TIPO_MAQUINA (ID_TIPO, NOMBRE_TIPO, DESCRIPCION) VALUES (402, 'Prensa Hidráulica', 'Equipo de moldeo y compresión');

INSERT INTO TURNO (ID_TURNO, NOMBRE_TURNO, HORA_INICIO, HORA_FIN) VALUES (501, 'Mañana', '06:00', '14:00');
INSERT INTO TURNO (ID_TURNO, NOMBRE_TURNO, HORA_INICIO, HORA_FIN) VALUES (502, 'Noche', '22:00', '06:00');

-- Máquinas (Requiere PLANTA y TIPO_MAQUINA)
INSERT INTO MAQUINA (ID_PLANTA, ID_MAQUINA, NOMBRE, FECHA_INSTALACION, ID_TIPO_MAQUINA) VALUES (301, 1001, 'CT-01', DATE '2022-01-15', 401);
INSERT INTO MAQUINA (ID_PLANTA, ID_MAQUINA, NOMBRE, FECHA_INSTALACION, ID_TIPO_MAQUINA) VALUES (301, 1002, 'PH-05', DATE '2023-05-20', 402);
INSERT INTO MAQUINA (ID_PLANTA, ID_MAQUINA, NOMBRE, FECHA_INSTALACION, ID_TIPO_MAQUINA) VALUES (302, 2001, 'CT-03', DATE '2021-11-01', 401);

-- Empleado (Jefes)
INSERT INTO EMPLEADO (ID_EMPLEADO, ID_SUBTIPO, RUT, NOMBRES, APELLIDOS, FECHA_CONTRATO, SALARIO, ID_PLANTA, ID_AFP, ID_SISTEMA, ID_JEFE_DIRECTO) 
VALUES (100, 1, '11.111.111-1', 'Jefe', 'General', DATE '2010-01-01', 2000000, 301, 101, 201, NULL);

-- Empleados Base (Requiere PLANTA, AFP, SISTEMA_SALUD)
-- Empleado 1: Jefe de Turno (ID_SUBTIPO = 2)
INSERT INTO EMPLEADO (ID_EMPLEADO, ID_SUBTIPO, RUT, NOMBRES, APELLIDOS, FECHA_CONTRATO, SALARIO, ID_PLANTA, ID_AFP, ID_SISTEMA, ID_JEFE_DIRECTO) 
VALUES (101, 2, '12.121.212-2', 'Pedro', 'Mendez', DATE '2015-06-10', 1500000, 301, 101, 202, 100);

-- Empleado 2: Operario (ID_SUBTIPO = 3)
INSERT INTO EMPLEADO (ID_EMPLEADO, ID_SUBTIPO, RUT, NOMBRES, APELLIDOS, FECHA_CONTRATO, SALARIO, ID_PLANTA, ID_AFP, ID_SISTEMA, ID_JEFE_DIRECTO) 
VALUES (102, 3, '13.131.313-3', 'Ana', 'Rojas', DATE '2018-03-01', 850000, 301, 102, 201, 101);

-- Empleado 3: Técnico Mantención (ID_SUBTIPO = 4)
INSERT INTO EMPLEADO (ID_EMPLEADO, ID_SUBTIPO, RUT, NOMBRES, APELLIDOS, FECHA_CONTRATO, SALARIO, ID_PLANTA, ID_AFP, ID_SISTEMA, ID_JEFE_DIRECTO) 
VALUES (103, 4, '14.141.414-4', 'Carlos', 'Vargas', DATE '2020-11-20', 1200000, 302, 102, 202, 100);


-- Subtipos (Requiere EMPLEADO)
-- Pedro Mendez (ID_SUBTIPO=2) es JEFE_TURNO
INSERT INTO JEFE_TURNO (ID_SUBTIPO, AREA_RESPONSABILIDAD, MAX_OPERARIOS) VALUES (2, 'Producción Línea A', 15);

-- Ana Rojas (ID_SUBTIPO=3) es OPERARIO
INSERT INTO OPERARIO (ID_SUBTIPO, CATEGORIA_PROCESO, CERTIFICACION, HORAS_ESTANDAR_TURNO) VALUES (3, 'Montaje', 'Certificado Nivel 3', 8);

-- Carlos Vargas (ID_SUBTIPO=4) es TECNICO_MANTENCION
INSERT INTO TECNICO_MANTENCION (ID_SUBTIPO, ESPECIALIDAD, NIVEL_CERTIFICACION, TIEMPO_RESPUESTA_ESTANDAR) VALUES (4, 'Hidráulica', 'Senior', 60);


-- Órdenes de Mantención (Requiere MAQUINA - FK Compuesta)
INSERT INTO ORDEN_MANTENCION (ID_ORDEN, FECHA_PROGRAMADA, DESCRIPCION_TRABAJO, ID_PLANTA, ID_MAQUINA) 
VALUES (1, DATE '2025-11-05', 'Reemplazo de rodamientos en la cinta CT-01.', 301, 1001);

INSERT INTO ORDEN_MANTENCION (ID_ORDEN, FECHA_PROGRAMADA, DESCRIPCION_TRABAJO, ID_PLANTA, ID_MAQUINA) 
VALUES (2, DATE '2025-11-06', 'Calibración de cilindros PH-05.', 301, 1002);

-- Asignación de Turno (Requiere EMPLEADO, TURNO, MAQUINA - PK y FK Compuesta)
INSERT INTO ASIGNACION_TURNO (FECHA, ID_EMPLEADO, ID_TURNO, ID_PLANTA, ID_MAQUINA, ROL_DESEMPEÑADO)
VALUES (DATE '2025-10-15', 102, 501, 301, 1001, 'Operador Principal'); -- Ana (Operaria) en CT-01

INSERT INTO ASIGNACION_TURNO (FECHA, ID_EMPLEADO, ID_TURNO, ID_PLANTA, ID_MAQUINA, ROL_DESEMPEÑADO)
VALUES (DATE '2025-10-15', 101, 501, 301, 1001, 'Supervisor de Línea'); -- Pedro (Jefe) supervisando

INSERT INTO ASIGNACION_TURNO (FECHA, ID_EMPLEADO, ID_TURNO, ID_PLANTA, ID_MAQUINA, ROL_DESEMPEÑADO)
VALUES (DATE '2025-10-16', 103, 502, 302, 2001, 'Mantenimiento Preventivo'); -- Carlos (Técnico) en CT-03

COMMIT;


-- 7. CONSULTA DE EJEMPLO (Recuperación de datos requerida)
-- Mostrar la asignación de personal para el turno de la mañana (501) del 15 de octubre en la Planta Norte (301)
SELECT
    E.NOMBRES || ' ' || E.APELLIDOS AS EMPLEADO,
    CASE
        WHEN JT.ID_SUBTIPO IS NOT NULL THEN 'JEFE_TURNO'
        WHEN O.ID_SUBTIPO IS NOT NULL THEN 'OPERARIO'
        WHEN TM.ID_SUBTIPO IS NOT NULL THEN 'TECNICO_MANTENCION'
        ELSE 'N/A'
    END AS ROL_PRINCIPAL,
    A.ROL_DESEMPEÑADO AS ROL_ASIGNADO,
    T.NOMBRE_TURNO,
    M.NOMBRE AS MAQUINA_ASIGNADA,
    P.NOMBRE_PLANTA
FROM
    ASIGNACION_TURNO A
JOIN
    EMPLEADO E ON A.ID_EMPLEADO = E.ID_EMPLEADO
JOIN
    TURNO T ON A.ID_TURNO = T.ID_TURNO
JOIN
    MAQUINA M ON A.ID_PLANTA = M.ID_PLANTA AND A.ID_MAQUINA = M.ID_MAQUINA -- Unión por clave compuesta
JOIN
    PLANTA P ON M.ID_PLANTA = P.ID_PLANTA
LEFT JOIN
    OPERARIO O ON E.ID_SUBTIPO = O.ID_SUBTIPO -- Determina el subtipo
LEFT JOIN
    JEFE_TURNO JT ON E.ID_SUBTIPO = JT.ID_SUBTIPO
LEFT JOIN
    TECNICO_MANTENCION TM ON E.ID_SUBTIPO = TM.ID_SUBTIPO
WHERE
    A.FECHA = DATE '2025-10-15'
    AND A.ID_TURNO = 501
    AND A.ID_PLANTA = 301;
    
